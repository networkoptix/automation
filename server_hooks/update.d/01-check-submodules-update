#!/bin/bash

set -e

declare -r REFNAME=$1
declare -r SHA_OLD=$2
declare -r SHA_NEW=$3

declare -ar SUBMODULES=(conan_recipes)

case "${REFNAME}" in
    refs/heads/*)
        if expr "${SHA_NEW}" : '0*$' >/dev/null
        then
            exit 0 #< Branch was deleted.
        fi

        declare -r COMMIT_MESSAGE="$(git log --format=%B -n1 "${SHA_NEW}")"
        while IFS= read -r FILE_NAME
        do
            if printf '%s\n' "${SUBMODULES[@]}" | grep --quiet ^"${FILE_NAME}"$
            then
                declare -r CONFIRM_STRING="Update submodule ${FILE_NAME}"
                if ! [[ "${COMMIT_MESSAGE}" =~ "${CONFIRM_STRING}" ]]
                then
                    cat <<ERROR_MESSAGE
GL-HOOK-ERR: WARNING: Submodule ${FILE_NAME} has been implicitly changed in commit:
$(git log --oneline -1 "${SHA_NEW}").

Please either revert submodule revision change or add the following text into the commit
description if you REALLY want to change the submodule revision:

${CONFIRM_STRING}.

To revert the submodule revision you can use interactive rebase or amend (if the change was in the latest commit).
${SHA_NEW}.
ERROR_MESSAGE
                    exit 1
                fi
            fi
        done <<< "$(git show --pretty="format:" --name-only "${SHA_NEW}")"
        ;;
esac
